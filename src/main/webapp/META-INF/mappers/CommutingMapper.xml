<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.awoo.dao.CommutingDAO">
	<select id="selectCommuting" parameterType="Map" resultType="CommutingVO">
<!-- 		select id, workday, DATE_FORMAT(start_time, '%H:%i') as start_time, DATE_FORMAT(end_time, '%H:%i') as end_time, work_time, over_time, empno -->
<!-- 		from commuting WHERE empno=#{empno} order by id desc ; -->
	
<!-- 			select id, workday, DATE_FORMAT(start_time, '%H:%i') as start_time, DATE_FORMAT(end_time, '%H:%i') as end_time, work_time, over_time, empno -->
<!-- 			from commuting  -->
<!-- 			<where> -->
<!-- 				empno=#{empno} -->
<!-- 				<if test="workday.equals('0-0')">  -->
<!-- 				and DATE_FORMAT(workday, '%Y-%m') >= #{workday} -->
<!-- 				</if> -->
<!-- 				<if test="!workday.equals('0-0') and workday != null">  -->
<!-- 				and DATE_FORMAT(workday, '%Y-%m') = #{workday} -->
<!-- 				</if> -->
<!-- 			</where> -->
<!-- 			order by id desc -->

			select id, workday, DATE_FORMAT(start_time, '%H:%i') as start_time, DATE_FORMAT(end_time, '%H:%i') as end_time, work_time, over_time, empno
			from commuting  
			<where>
				empno=#{empno}
				
				<if test="month == null">
					and 1=1
				</if>
				<if test="year == null">
					and 1=1
				</if>
				<if test="month != null">
					and DATE_FORMAT(workday, '%m') = #{month}
				</if>
				<if test="year != null">
					and DATE_FORMAT(workday, '%Y') = #{year}
				</if>
				
			</where>
			order by id desc
	</select>
	<insert id="insertEnter" keyProperty="id">
		INSERT INTO commuting(start_time, empno, over_time) 
		VALUES (#{startTime}, #{empno}, #{overTime});
	</insert>
	<update id="insertLeave">
		update commuting
			set end_time = #{endTime},
				work_time = #{workTime},
				over_time = #{overTime}
			WHERE empno=#{empno} AND DATE_FORMAT(workday, '%Y-%m-%d') = #{workday};
	</update>
	<select id="getStartTime" resultType="String">
<!-- 		select DATE_FORMAT(start_time, '%H:%i:%s %p') -->

<!-- 		select DATE_FORMAT(start_time, '%Y-%m-%d %H:%i:%s') -->
		select DATE_FORMAT(start_time, '%H:%i')
		from commuting WHERE DATE_FORMAT(workday, '%Y-%m-%d') = #{workday} AND empno=#{empno};
	</select>
		<select id="getEndTime" resultType="String">
<!-- 		select DATE_FORMAT(start_time, '%H:%i:%s %p') -->
<!-- 		select DATE_FORMAT(end_time, '%Y-%m-%d %H:%i:%s') -->
		select DATE_FORMAT(end_time, '%H:%i')
		from commuting WHERE DATE_FORMAT(workday, '%Y-%m-%d') = #{workday} AND empno=#{empno};
	</select>
	<select id="getDistinctYear" resultType="String">
		select distinct(DATE_FORMAT(workday, '%Y')) from commuting order by (DATE_FORMAT(workday, '%Y')) desc
	</select>
	<select id="getDistinctMonth" resultType="String">
		select distinct(DATE_FORMAT(workday, '%m')) from commuting order by (DATE_FORMAT(workday, '%m')) desc;
	</select>
	<select id="countOverTime" resultType="int">
		SELECT COUNT(over_time) FROM commuting
		WHERE over_time != "-" and empno = #{empno} AND DATE_FORMAT(workday, '%m') = #{workday};
	</select>
	<select id="countLate" resultType="int">
		SELECT COUNT(workday) FROM commuting
		WHERE empno=#{empno} AND 
		DATE_FORMAT(workday,'%m')=#{workday} AND
		date_format(start_time,'%H:%i')>'09:10';
	</select>
	
</mapper>